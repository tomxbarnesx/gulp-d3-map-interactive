var sealevelDataset = [
	{ser1: 1960, ser2: -70.38}, 
	{ser1: 1961, ser2: -60.25}, 
	{ser1: 1962, ser2: -66.68}, 
	{ser1: 1963, ser2: -63.88}, 
	{ser1: 1964, ser2: -77.95}, 
	{ser1: 1965, ser2: -66.18}, 
	{ser1: 1966, ser2: -64.28}, 
	{ser1: 1967, ser2: -72.91}, 
	{ser1: 1968, ser2: -63.48}, 
	{ser1: 1969, ser2: -59.71}, 
	{ser1: 1970, ser2: -61.51},
	{ser1: 1971, ser2: -57.48},
	{ser1: 1972, ser2: -56.51},
	{ser1: 1973, ser2: -54.68},
	{ser1: 1974, ser2: -40.18},
	{ser1: 1975, ser2: -43.95},
	{ser1: 1976, ser2: -46.68},
	{ser1: 1977, ser2: -44.25},
	{ser1: 1978, ser2: -39.25},
	{ser1: 1979, ser2: -49.61},
	{ser1: 1980, ser2: -37.68},
	{ser1: 1981, ser2: -31.08},
	{ser1: 1982, ser2: -30.21},
	{ser1: 1983, ser2: -23.55},
	{ser1: 1984, ser2: -30.48},
	{ser1: 1985, ser2: -31.68},
	{ser1: 1986, ser2: -33.81},
	{ser1: 1987, ser2: -33.85},
	{ser1: 1988, ser2: -31.41},
	{ser1: 1989, ser2: -31.85},
	{ser1: 1990, ser2: -25.25},
	{ser1: 1991, ser2: -20.35},
	{ser1: 1992, ser2: -16.38},
	{ser1: 1993, ser2: -19.58},
	{ser1: 1994, ser2: -22.35},
	{ser1: 1995, ser2: -16.35},
	{ser1: 1996, ser2: -7.25},
	{ser1: 1997, ser2: -6.48},
	{ser1: 1998, ser2: -1.85},
	{ser1: 1999, ser2: -8.48},
	{ser1: 2000, ser2: -8.43},
	{ser1: 2001, ser2: -0.81},
	{ser1: 2002, ser2: -2.73},
	{ser1: 2003, ser2: 4.38},
	{ser1: 2004, ser2: 8.25},
	{ser1: 2005, ser2: 10.62},
	{ser1: 2006, ser2: 6.65},
	{ser1: 2007, ser2: 4.39},
	{ser1: 2008, ser2: 17.55},
	{ser1: 2009, ser2: 19.32},
	{ser1: 2010, ser2: 44.19},
	{ser1: 2011, ser2: 38.33},
	{ser1: 2012, ser2: 38.96},
	{ser1: 2013, ser2: 50.05},
	{ser1: 2014, ser2: 48.02},
	{ser1: 2015, ser2: 58.15},
	{ser1: 2016, ser2: 61.52},
	{ser1: 2017, ser2: 61.59},
	{ser1: 2018, ser2: 56.67},
	{ser1: 2019, ser2: 66.43}
];

var carbonDataset = [
	{ser1: 1960, ser2: 316.91},
	{ser1: 1961, ser2: 317.64},
	{ser1: 1962, ser2: 318.45},
	{ser1: 1963, ser2: 318.99},
	{ser1: 1964, ser2: 319.62},
	{ser1: 1965, ser2: 320.04},
	{ser1: 1966, ser2: 321.38},
	{ser1: 1967, ser2: 322.16},
	{ser1: 1968, ser2: 323.04},
	{ser1: 1969, ser2: 324.62},
	{ser1: 1970, ser2: 325.68},
	{ser1: 1971, ser2: 326.32},
	{ser1: 1972, ser2: 327.45},
	{ser1: 1973, ser2: 329.68},
	{ser1: 1974, ser2: 330.18},
	{ser1: 1975, ser2: 331.11},
	{ser1: 1976, ser2: 332.04},
	{ser1: 1977, ser2: 333.83},
	{ser1: 1978, ser2: 335.4},
	{ser1: 1979, ser2: 336.84},
	{ser1: 1980, ser2: 338.75},
	{ser1: 1981, ser2: 340.11},
	{ser1: 1982, ser2: 341.45},
	{ser1: 1983, ser2: 343.05},
	{ser1: 1984, ser2: 344.65},
	{ser1: 1985, ser2: 346.12},
	{ser1: 1986, ser2: 347.42},
	{ser1: 1987, ser2: 349.19},
	{ser1: 1988, ser2: 351.57},
	{ser1: 1989, ser2: 353.12},
	{ser1: 1990, ser2: 354.39},
	{ser1: 1991, ser2: 355.61},
	{ser1: 1992, ser2: 356.45},
	{ser1: 1993, ser2: 357.1},
	{ser1: 1994, ser2: 358.83},
	{ser1: 1995, ser2: 360.82},
	{ser1: 1996, ser2: 362.61},
	{ser1: 1997, ser2: 363.73},
	{ser1: 1998, ser2: 366.7},
	{ser1: 1999, ser2: 368.38},
	{ser1: 2000, ser2: 369.55},
	{ser1: 2001, ser2: 371.14},
	{ser1: 2002, ser2: 373.28},
	{ser1: 2003, ser2: 375.8},
	{ser1: 2004, ser2: 377.52},
	{ser1: 2005, ser2: 379.8},
	{ser1: 2006, ser2: 381.9},
	{ser1: 2007, ser2: 383.79},
	{ser1: 2008, ser2: 385.6},
	{ser1: 2009, ser2: 387.43},
	{ser1: 2010, ser2: 389.9},
	{ser1: 2011, ser2: 391.65},
	{ser1: 2012, ser2: 393.85},
	{ser1: 2013, ser2: 396.52},
	{ser1: 2014, ser2: 398.65},
	{ser1: 2015, ser2: 400.83},
	{ser1: 2016, ser2: 404.24},
	{ser1: 2017, ser2: 406.55},
	{ser1: 2018, ser2: 408.52},
	{ser1: 2019, ser2: 411.44},
];

let init = false, activeDataset = carbonDataset, chartMaster = document.getElementsByClassName("chart-master-container")[0], prevEl = document.getElementsByClassName("dataset-button")[0];

var svgWidth = chartMaster.offsetWidth, 
	svgHeight = chartMaster.offsetHeight,
	margin = {top: 10, right: 15, bottom: 30, left: 60},
    width = svgWidth - margin.left - margin.right,
    height = svgHeight - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select(".chart-master-container")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Initialise a X axis:
var x = d3.scaleLinear().range([0,width]);
var xAxis = d3.axisBottom().scale(x).tickFormat(d3.format("d"));
svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .attr("class","myXaxis")

// Initialize an Y axis
var y = d3.scaleLinear().range([height, 0]);
var yAxis = d3.axisLeft().scale(y);
svg.append("g")
  .attr("class","myYaxis")

function handleDataSwitch(data, el) {
	if (activeDataset == data) {
		return true
	} else {
		prevEl.classList.remove("active");
		el.classList.add("active");
		prevEl=el;
		return update(data, activeYearIndex);
	}
}

// A function that takes a dataset as input and update the plot:
function update(data, index) {
	console.log("INDEX", index)
	// Create the X axis:
	var u, yLabel;
	x.domain([1959, d3.max(data, function(d) { return d.ser1 }) ]);
	svg.selectAll(".myXaxis").transition()
		.duration(2000)
		.call(xAxis);

	// X axis label
	// svg.append("text")             
 //      .attr("transform",
 //            "translate(" + (width/2) + " ," + 
 //                           (height + margin.top + 20) + ")")
 //      .attr("fill", "white")
 //      .style("text-anchor", "middle")
 //      .text("Year");

	// create the Y axis
	if (data == sealevelDataset) {
		y.domain([-85, d3.max(data, function(d) { return d.ser2  }) ]);
		yLabel = "Change from est. avg. (mm)"
	} else {
		y.domain([225, d3.max(data, function(d) { return d.ser2  }) ]);
		yLabel = "Atmospheric COÂ² (ppm)"
	}
	svg.selectAll(".myYaxis")
		.transition()
		.duration(2000)
		.call(yAxis);
	console.log(activeDataset == data);

	if (activeDataset != data || !init) {
		var textLabel = svg.append("text")
		.attr("class", "text")
		.attr("transform", "rotate(-90)")
		.attr("y", 0 - margin.left)
		.attr("x",0 - (height / 2))
		.attr("dy", "1.5em")
		.style("text-anchor", "middle")
		.attr("fill", "white")

		svg.selectAll(".text").transition()
		    .style("opacity", 0)
		    .transition().duration(2500)
		    .style("opacity", 1)
			.text(yLabel)
	}

	if (index || index === 0) {
		dataSlice = data.slice(0, index);
		u = svg.selectAll(".lineTest")
			.data([dataSlice], function(d){ return d.ser1 });
	} else {
		u = svg.selectAll(".lineTest")
			.data([data], function(d){ return d.ser1 });
	}

	// Update the line
	u
		.enter()
		.append("path")
		.attr("class","lineTest")
		.merge(u)
		.transition()
		.duration(2000)
		.attr("d", d3.line()
		.x(function(d) { return x(d.ser1); })
		.y(function(d) { return y(d.ser2); }))
		.attr("fill", "none")
		.attr("stroke", "steelblue")
		.attr("stroke-width", 4)

	activeDataset = data
}

// At the beginning, I run the update function on the first dataset:
update(carbonDataset, 0)
init = true;